# ğŸš€ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§è‡ªå‹•çš„ã«ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®Ÿè¡Œ

name: Deploy to Xserver

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# ç’°å¢ƒå¤‰æ•°
env:
  NODE_VERSION: '20'
  
# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build:
    runs-on: ubuntu-latest
    
    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    # ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - name: ğŸ“¦ Install dependencies
      run: |
        cd frontend
        npm ci
        
    # ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
    - name: ğŸ” Create environment file
      run: |
        cd frontend
        echo "NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.SANITY_PROJECT_ID }}" > .env.local
        echo "NEXT_PUBLIC_SANITY_DATASET=${{ secrets.SANITY_DATASET }}" >> .env.local
        echo "NEXT_PUBLIC_SANITY_API_VERSION=${{ secrets.SANITY_API_VERSION }}" >> .env.local
        echo "SANITY_API_READ_TOKEN=${{ secrets.SANITY_API_READ_TOKEN }}" >> .env.local
        echo "SANITY_PREVIEW_SECRET=${{ secrets.SANITY_PREVIEW_SECRET }}" >> .env.local
        
    # Site_5ãƒ•ã‚¡ã‚¤ãƒ«ã®æº–å‚™ï¼ˆSanityé€£æºå¯¾å¿œï¼‰
    - name: ğŸ—ï¸ Prepare site_5 for deployment
      run: |
        echo "ğŸ“‚ Sanityé€£æºã‚µã‚¤ãƒˆï¼ˆsite_5ï¼‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ä¸­..."
        
        # site_5ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        if [ -d "site_5" ]; then
          echo "âœ… site_5ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          ls -la site_5/
        else
          echo "âŒ site_5ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          exit 1
        fi
        
    # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆsite_5é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
    - name: ğŸ“ Upload site_5 files
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: site_5/
        retention-days: 1
        
    # .htaccessãƒ•ã‚¡ã‚¤ãƒ«ã‚’site_5ã«ã‚³ãƒ”ãƒ¼ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ç”¨ï¼‰
    - name: ğŸ“„ Copy .htaccess to site_5
      run: |
        if [ -f "frontend/.htaccess" ]; then
          cp frontend/.htaccess site_5/.htaccess
          echo "âœ… .htaccessãƒ•ã‚¡ã‚¤ãƒ«ã‚’site_5ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"
        else
          echo "âš ï¸ .htaccessãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
        fi

  # ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¸ãƒ§ãƒ–ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    # ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    - name: ğŸ“¥ Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: ./build
        
    # FTPã‚µãƒ¼ãƒãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ­£è¦åŒ–
    - name: ğŸ”§ Normalize FTP server directory
      run: |
        SERVER_DIR="${{ secrets.FTP_SERVER_DIR }}"
        # æœ«å°¾ã«ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’è¿½åŠ ï¼ˆãªã‘ã‚Œã°ï¼‰
        if [[ ! "$SERVER_DIR" =~ /$ ]]; then
          SERVER_DIR="${SERVER_DIR}/"
        fi
        echo "NORMALIZED_SERVER_DIR=${SERVER_DIR}" >> $GITHUB_ENV
        echo "ğŸ“ æ­£è¦åŒ–ã•ã‚ŒãŸã‚µãƒ¼ãƒãƒ¼ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: ${SERVER_DIR}"
        
    # FTPã§Xserverã«ãƒ‡ãƒ—ãƒ­ã‚¤
    - name: ğŸš€ Deploy to Xserver via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./build/
        server-dir: ${{ env.NORMALIZED_SERVER_DIR }}
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/.env*
          **/logs/**
          **/tmp/**
          
    # ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ã‚µã‚¤ãƒˆå‹•ä½œç¢ºèª
    - name: ğŸ” Verify deployment
      if: success()
      run: |
        echo "ğŸ” ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ã‚µã‚¤ãƒˆç¢ºèªä¸­..."
        # åŸºæœ¬çš„ãªæ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆURLã¯å®Ÿéš›ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ç½®ãæ›ãˆï¼‰
        # curl -f -s -o /dev/null https://yourdomain.com || echo "âš ï¸ ã‚µã‚¤ãƒˆã®å¿œç­”ç¢ºèªãŒå¿…è¦ã§ã™"
        
    # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
    - name: ğŸ“§ Notify deployment success
      if: success()
      run: |
        echo "ğŸ‰ Sanityé€£æºã‚µã‚¤ãƒˆï¼ˆsite_5ï¼‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæˆåŠŸã—ã¾ã—ãŸï¼"
        echo "ğŸ“… ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"
        echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://yourdomain.com"
        echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find ./build -type f | wc -l)"
        echo ""
        echo "âœ¨ æ–°æ©Ÿèƒ½ï¼š"
        echo "  ğŸ”— Sanity CMSé€£æºå¯¾å¿œ"
        echo "  ğŸ“° NEWSã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‹•çš„æ›´æ–°"
        echo "  âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–æ¸ˆã¿"
        echo ""
        echo "ğŸ”§ Sanity Studio: http://localhost:3333"
        echo "ğŸ“ æŠ•ç¨¿ã‚’è¿½åŠ ã™ã‚‹ã¨è‡ªå‹•ã§ã‚µã‚¤ãƒˆã«åæ˜ ã•ã‚Œã¾ã™"
        
    # ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—é€šçŸ¥ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    - name: âŒ Notify deployment failure
      if: failure()
      run: |
        echo "âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸ"
        echo "ğŸ“… å¤±æ•—æ™‚åˆ»: $(date)"
        echo "ğŸ”§ ç¢ºèªäº‹é …:"
        echo "  - FTPæ¥ç¶šæƒ…å ±ã®ç¢ºèª"
        echo "  - ã‚µãƒ¼ãƒãƒ¼ã®å®¹é‡ç¢ºèª"
        echo "  - ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã®ç¢ºèª"
        echo "ğŸ“‹ GitHub Secretsã®ç¢ºèª:"
        echo "  - FTP_SERVER: $(if [ -n "${{ secrets.FTP_SERVER }}" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"
        echo "  - FTP_USERNAME: $(if [ -n "${{ secrets.FTP_USERNAME }}" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"
        echo "  - FTP_PASSWORD: $(if [ -n "${{ secrets.FTP_PASSWORD }}" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"
        echo "  - FTP_SERVER_DIR: $(if [ -n "${{ secrets.FTP_SERVER_DIR }}" ]; then echo "è¨­å®šæ¸ˆã¿"; else echo "æœªè¨­å®š"; fi)"

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    # è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ¬ãƒ™ãƒ«ã®ã¿ï¼‰
    - name: ğŸ” Security audit
      run: |
        cd frontend
        npm install
        npm audit --audit-level critical || echo "âš ï¸ é‡å¤§ã§ãªã„è„†å¼±æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯ä¿®æ­£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
        
    # ä¾å­˜é–¢ä¿‚ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
    - name: ğŸ“„ License check
      run: |
        cd frontend
        npx license-checker --summary