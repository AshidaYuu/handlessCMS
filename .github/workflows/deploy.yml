# 🚀 自動デプロイワークフロー
# mainブランチへのpushで自動的にビルド・デプロイを実行

name: Deploy to Xserver

# トリガー条件
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# 環境変数
env:
  NODE_VERSION: '20'
  
# ジョブ定義
jobs:
  # ビルドジョブ
  build:
    runs-on: ubuntu-latest
    
    steps:
    # リポジトリのチェックアウト
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      
    # Node.jsのセットアップ
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
        
    # 依存関係のインストール
    - name: 📦 Install dependencies
      run: |
        cd frontend
        npm ci
        
    # 環境変数の設定
    - name: 🔐 Create environment file
      run: |
        cd frontend
        echo "NEXT_PUBLIC_SANITY_PROJECT_ID=${{ secrets.SANITY_PROJECT_ID }}" > .env.local
        echo "NEXT_PUBLIC_SANITY_DATASET=${{ secrets.SANITY_DATASET }}" >> .env.local
        echo "NEXT_PUBLIC_SANITY_API_VERSION=${{ secrets.SANITY_API_VERSION }}" >> .env.local
        echo "SANITY_API_READ_TOKEN=${{ secrets.SANITY_API_READ_TOKEN }}" >> .env.local
        echo "SANITY_PREVIEW_SECRET=${{ secrets.SANITY_PREVIEW_SECRET }}" >> .env.local
        
    # Site_5ファイルの準備（Sanity連携対応）
    - name: 🏗️ Prepare site_5 for deployment
      run: |
        echo "📂 Sanity連携サイト（site_5）をデプロイ準備中..."
        
        # site_5ディレクトリが存在することを確認
        if [ -d "site_5" ]; then
          echo "✅ site_5ディレクトリが見つかりました"
          ls -la site_5/
        else
          echo "❌ site_5ディレクトリが見つかりません"
          exit 1
        fi
        
    # ビルド成果物のアップロード（site_5静的ファイル）
    - name: 📁 Upload site_5 files
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: site_5/
        retention-days: 1
        
    # .htaccessファイルをsite_5にコピー（パフォーマンス最適化用）
    - name: 📄 Copy .htaccess to site_5
      run: |
        if [ -f "frontend/.htaccess" ]; then
          cp frontend/.htaccess site_5/.htaccess
          echo "✅ .htaccessファイルをsite_5にコピーしました"
        else
          echo "⚠️ .htaccessファイルが見つかりません"
        fi

  # デプロイジョブ（mainブランチのみ）
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    # ビルド成果物のダウンロード
    - name: 📥 Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: ./build
        
    # FTPサーバーディレクトリの正規化
    - name: 🔧 Normalize FTP server directory
      run: |
        SERVER_DIR="${{ secrets.FTP_SERVER_DIR }}"
        # 末尾にスラッシュを追加（なければ）
        if [[ ! "$SERVER_DIR" =~ /$ ]]; then
          SERVER_DIR="${SERVER_DIR}/"
        fi
        echo "NORMALIZED_SERVER_DIR=${SERVER_DIR}" >> $GITHUB_ENV
        echo "📁 正規化されたサーバーディレクトリ: ${SERVER_DIR}"
        
    # FTPでXserverにデプロイ
    - name: 🚀 Deploy to Xserver via FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./build/
        server-dir: ${{ env.NORMALIZED_SERVER_DIR }}
        dangerous-clean-slate: false
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/.env*
          **/logs/**
          **/tmp/**
          
    # デプロイ後のサイト動作確認
    - name: 🔍 Verify deployment
      if: success()
      run: |
        echo "🔍 デプロイ後のサイト確認中..."
        # 基本的な接続テスト（URLは実際のドメインに置き換え）
        # curl -f -s -o /dev/null https://yourdomain.com || echo "⚠️ サイトの応答確認が必要です"
        
    # デプロイ成功通知
    - name: 📧 Notify deployment success
      if: success()
      run: |
        echo "🎉 Sanity連携サイト（site_5）のデプロイが成功しました！"
        echo "📅 デプロイ時刻: $(date)"
        echo "🌐 サイトURL: https://yourdomain.com"
        echo "📊 デプロイファイル数: $(find ./build -type f | wc -l)"
        echo ""
        echo "✨ 新機能："
        echo "  🔗 Sanity CMS連携対応"
        echo "  📰 NEWSセクションの動的更新"
        echo "  ⚡ パフォーマンス最適化済み"
        echo ""
        echo "🔧 Sanity Studio: http://localhost:3333"
        echo "📝 投稿を追加すると自動でサイトに反映されます"
        
    # デプロイ失敗通知とトラブルシューティング
    - name: ❌ Notify deployment failure
      if: failure()
      run: |
        echo "❌ デプロイに失敗しました"
        echo "📅 失敗時刻: $(date)"
        echo "🔧 確認事項:"
        echo "  - FTP接続情報の確認"
        echo "  - サーバーの容量確認"
        echo "  - ファイル権限の確認"
        echo "📋 GitHub Secretsの確認:"
        echo "  - FTP_SERVER: $(if [ -n "${{ secrets.FTP_SERVER }}" ]; then echo "設定済み"; else echo "未設定"; fi)"
        echo "  - FTP_USERNAME: $(if [ -n "${{ secrets.FTP_USERNAME }}" ]; then echo "設定済み"; else echo "未設定"; fi)"
        echo "  - FTP_PASSWORD: $(if [ -n "${{ secrets.FTP_PASSWORD }}" ]; then echo "設定済み"; else echo "未設定"; fi)"
        echo "  - FTP_SERVER_DIR: $(if [ -n "${{ secrets.FTP_SERVER_DIR }}" ]; then echo "設定済み"; else echo "未設定"; fi)"

  # セキュリティチェックジョブ
  security:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout repository
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    # 脆弱性チェック（クリティカルレベルのみ）
    - name: 🔍 Security audit
      run: |
        cd frontend
        npm install
        npm audit --audit-level critical || echo "⚠️ 重大でない脆弱性があります。本番環境では修正を検討してください。"
        
    # 依存関係ライセンスチェック
    - name: 📄 License check
      run: |
        cd frontend
        npx license-checker --summary