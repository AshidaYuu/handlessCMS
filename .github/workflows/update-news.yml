# ğŸ“° SanityæŠ•ç¨¿æ›´æ–°æ™‚ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Sanity Webhookã¾ãŸã¯Repository Dispatchã§å®Ÿè¡Œ

name: Update News from Sanity

# ãƒˆãƒªã‚¬ãƒ¼æ¡ä»¶
on:
  repository_dispatch:
    types: [sanity-update]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      reason:
        description: 'Update reason'
        required: false
        default: 'Manual news update'

# ç’°å¢ƒå¤‰æ•°
env:
  NODE_VERSION: '20'

# ã‚¸ãƒ§ãƒ–å®šç¾©
jobs:
  update-news:
    runs-on: ubuntu-latest
    
    steps:
    # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      
    # Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    # Sanityã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦JSONã‚’ç”Ÿæˆ
    - name: ğŸ“¡ Fetch data from Sanity and update JSON
      run: |
        echo "ğŸ” Sanityã‹ã‚‰ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­..."
        
        # Sanity APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        SANITY_URL="https://rt90f87e.api.sanity.io/v2024-01-01/data/query/production"
        QUERY='*[_type == "post"] | order(publishedAt desc)[0...4] {title, publishedAt, slug, excerpt}'
        ENCODED_QUERY=$(node -e "console.log(encodeURIComponent('$QUERY'))")
        
        echo "ğŸ“¡ Sanity APIã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­..."
        echo "URL: ${SANITY_URL}?query=${ENCODED_QUERY}"
        
        # curlã§ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆJSONPã§ã¯ãªãç›´æ¥å–å¾—ã‚’è©¦è¡Œï¼‰
        RESPONSE=$(curl -s "${SANITY_URL}?query=${ENCODED_QUERY}")
        echo "ğŸ“Š Sanityå¿œç­”: $RESPONSE"
        
        # ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ããŸå ´åˆã¯å‡¦ç†ã€å¤±æ•—ã—ãŸå ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if echo "$RESPONSE" | grep -q '"result"'; then
          echo "âœ… Sanityã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ"
          echo "$RESPONSE" | node -e "
            const data = JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8'));
            const posts = data.result || [];
            console.log('å–å¾—ã—ãŸæŠ•ç¨¿æ•°:', posts.length);
            require('fs').writeFileSync('site_5/news-data.json', JSON.stringify(posts, null, 2));
            console.log('âœ… news-data.json ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          "
        else
          echo "âš ï¸ Sanityã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¾ã™"
          echo "$RESPONSE"
        fi
        
    # å¤‰æ›´ãŒã‚ã‚Œã°ã‚³ãƒŸãƒƒãƒˆ
    - name: ğŸ“ Commit updated news data
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --exit-code site_5/news-data.json; then
          echo "ğŸ“„ ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
        else
          echo "ğŸ“ ãƒ‹ãƒ¥ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€ã‚³ãƒŸãƒƒãƒˆä¸­..."
          git add site_5/news-data.json
          git commit -m "$(cat <<'EOF'
        auto: Update news data from Sanity CMS

        Automatically generated from Sanity Studio post updates.
        
        ğŸ¤– Generated with [Claude Code](https://claude.ai/code)
        
        Co-Authored-By: Claude <noreply@anthropic.com>
        EOF
        )"
          git push
          echo "âœ… å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"
        fi
        
    # ã‚µã‚¤ãƒˆæ›´æ–°ã®é€šçŸ¥
    - name: ğŸ“§ Notify update completion
      run: |
        echo "ğŸ‰ ãƒ‹ãƒ¥ãƒ¼ã‚¹æ›´æ–°ãƒ—ãƒ­ã‚»ã‚¹ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
        echo "ğŸ“… æ›´æ–°æ™‚åˆ»: $(date)"
        echo "ğŸŒ ã‚µã‚¤ãƒˆURL: https://kanauuu.okigaruweb.com"
        echo "ğŸ“ ç†ç”±: ${{ github.event.inputs.reason || 'Sanity webhook trigger' }}"